---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Badge from '../../components/Badge.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import Callout from '../../components/Callout.astro';
import ResourceCard from '../../components/ResourceCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const notes = await getCollection('garden');
  return notes.map((note) => ({
    params: { slug: note.slug },
    props: { note },
  }));
}

const { note } = Astro.props;
const { Content, headings } = await note.render();

const maturityEmojis = {
  seedling: 'ðŸŒ±',
  budding: 'ðŸŒ¿',
  evergreen: 'ðŸŒ³'
};

const maturityDescriptions = {
  seedling: 'New idea, rough notes, work in progress',
  budding: 'Developing thought, partially formed',
  evergreen: 'Mature, well-developed, regularly updated'
};

// Filter headings to only include h2s for TOC
const tocHeadings = headings?.filter(h => h.depth === 2) || [];
---

<BaseLayout 
  title={`${note.data.title} | Digital Garden`}
  description={note.data.description}
>
  <article class="container-custom">
    <Breadcrumb items={[
      { label: 'Home', href: '/' },
      { label: 'Garden', href: '/garden' },
      { label: note.data.title }
    ]} />
    
    {/* Header */}
    <header class="py-8 lg:py-12">
      {/* Maturity Banner */}
      <div class={`inline-flex items-center gap-2 px-4 py-2 rounded-lg mb-6 ${
        note.data.maturity === 'evergreen' 
          ? 'bg-green-500/10 border border-green-500/20 text-green-400' 
          : note.data.maturity === 'budding'
          ? 'bg-yellow-500/10 border border-yellow-500/20 text-yellow-400'
          : 'bg-blue-500/10 border border-blue-500/20 text-blue-400'
      }`}>
        <span class="text-2xl">{maturityEmojis[note.data.maturity]}</span>
        <div>
          <span class="text-sm font-medium capitalize">{note.data.maturity}</span>
          <p class="text-xs opacity-80">{maturityDescriptions[note.data.maturity]}</p>
        </div>
      </div>
      
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-foreground mb-4">
        {note.data.title}
      </h1>
      
      <p class="text-lg text-muted-foreground leading-relaxed max-w-3xl">
        {note.data.description}
      </p>
      
      <div class="flex flex-wrap gap-2 mt-6">
        {note.data.tags.map((tag) => (
          <Badge text={`#${tag}`} variant="default" />
        ))}
      </div>
    </header>

    {/* Main Content with Sidebar */}
    <div class="grid grid-cols-1 lg:grid-cols-[1fr_280px] gap-12 pb-12">
      {/* Content */}
      <div class="prose-custom min-w-0">
        <Content components={{ Callout, ResourceCard }} />
      </div>
      
      {/* Sidebar */}
      <aside class="hidden lg:block">
        <div class="sticky top-24 space-y-8">
          {/* Table of Contents */}
          {tocHeadings.length > 0 && (
            <div class="card p-5">
              <h3 class="text-sm font-semibold text-foreground uppercase tracking-wider mb-4">
                On this page
              </h3>
              <nav class="space-y-2">
                {tocHeadings.map((heading) => (
                  <a
                    href={`#${heading.slug}`}
                    class="block text-sm text-muted-foreground hover:text-emerald-400 transition-colors py-1 border-l-2 border-transparent hover:border-emerald-500 pl-3 -ml-3"
                  >
                    {heading.text}
                  </a>
                ))}
              </nav>
            </div>
          )}
          
          {/* Related Links */}
          {note.data.links.length > 0 && (
            <div class="card p-5">
              <h3 class="text-sm font-semibold text-foreground uppercase tracking-wider mb-4">
                Related Links
              </h3>
              <ul class="space-y-3">
                {note.data.links.map((link) => (
                  <li>
                    <a 
                      href={link}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="inline-flex items-center text-sm text-emerald-400 hover:text-emerald-300 transition-colors"
                    >
                      <svg class="mr-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                      <span class="truncate">{link.replace(/^https?:\/\//, '')}</span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          )}
          
          {/* Back to Garden */}
          <a 
            href="/garden"
            class="inline-flex items-center text-sm text-muted-foreground hover:text-emerald-400 transition-colors"
          >
            <svg class="mr-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            Back to the garden
          </a>
        </div>
      </aside>
    </div>
    
    {/* Mobile: Related Links & Back */}
    <div class="lg:hidden border-t border-white/10 py-8 space-y-8">
      {note.data.links.length > 0 && (
        <div>
          <h3 class="text-lg font-semibold text-foreground mb-4">
            Related Links
          </h3>
          <ul class="space-y-2">
            {note.data.links.map((link) => (
              <li>
                <a 
                  href={link}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center text-emerald-400 hover:text-emerald-300 transition-colors"
                >
                  <svg class="mr-2 w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                  </svg>
                  {link}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )}
      
      <a 
        href="/garden"
        class="inline-flex items-center text-emerald-400 hover:text-emerald-300 transition-colors"
      >
        <svg class="mr-2 w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to the garden
      </a>
    </div>
  </article>
</BaseLayout>

<script>
  // Highlight active TOC item on scroll
  const observerOptions = {
    root: null,
    rootMargin: '-20% 0px -80% 0px',
    threshold: 0
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const id = entry.target.getAttribute('id');
        document.querySelectorAll('aside nav a').forEach(link => {
          link.classList.remove('text-emerald-400', 'border-emerald-500');
          link.classList.add('text-muted-foreground', 'border-transparent');
        });
        const activeLink = document.querySelector(`aside nav a[href="#${id}"]`);
        if (activeLink) {
          activeLink.classList.remove('text-muted-foreground', 'border-transparent');
          activeLink.classList.add('text-emerald-400', 'border-emerald-500');
        }
      }
    });
  }, observerOptions);

  document.querySelectorAll('h2[id]').forEach(heading => {
    observer.observe(heading);
  });
</script>
