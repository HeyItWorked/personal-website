---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Badge from '../../components/Badge.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// Get prev/next posts for navigation
const allPosts = await getCollection('blog', (p) => !p.data.draft);
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime());
const currentIndex = sortedPosts.findIndex((p) => p.slug === post.slug);
const prevPost = sortedPosts[currentIndex + 1];
const nextPost = sortedPosts[currentIndex - 1];

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

// Calculate reading time (rough estimate: 200 words per minute)
function calculateReadingTime(content: string): number {
  const words = content.split(/\s+/).length;
  return Math.ceil(words / 200);
}

const readingTime = calculateReadingTime(post.body);
---

<BaseLayout 
  title={`${post.data.title} | Liam Nguyen`}
  description={post.data.description}
  section="personal"
>
  <article class="container-custom">
    <Breadcrumb items={[
      { label: 'Home', href: '/' },
      { label: 'Blog', href: '/blog' },
      { label: post.data.title }
    ]} />
    
    {/* Header */}
    <header class="py-8 lg:py-12 max-w-3xl">
      <div class="flex flex-wrap items-center gap-3 mb-6 text-sm text-[var(--color-text-muted)]">
        <time>{formatDate(post.data.pubDate)}</time>
        <span>•</span>
        <span>{readingTime} min read</span>
        {post.data.updatedDate && (
          <>
            <span>•</span>
            <span>Updated {formatDate(post.data.updatedDate)}</span>
          </>
        )}
      </div>
      
      <h1 class="text-3xl md:text-4xl lg:text-5xl font-bold text-[var(--color-text)] mb-6">
        {post.data.title}
      </h1>
      
      <p class="text-lg md:text-xl text-[var(--color-text-secondary)] leading-relaxed">
        {post.data.description}
      </p>
      
      <div class="flex flex-wrap gap-2 mt-6">
        {post.data.tags.map((tag) => (
          <Badge text={`#${tag}`} variant="default" />
        ))}
      </div>
    </header>

    {/* Content */}
    <div class="prose-custom max-w-3xl pb-16">
      <Content />
    </div>
    
    {/* Navigation */}
    <nav class="border-t border-[var(--color-border)] py-8">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {prevPost && (
          <a 
            href={`/blog/${prevPost.slug}`}
            class="card group flex flex-col"
          >
            <span class="text-sm text-[var(--color-text-muted)] mb-2">
              ← Previous
            </span>
            <span class="font-medium text-[var(--color-text)] group-hover:text-[var(--color-primary)] transition-colors">
              {prevPost.data.title}
            </span>
          </a>
        )}
        
        {nextPost && (
          <a 
            href={`/blog/${nextPost.slug}`}
            class={`card group flex flex-col ${!prevPost ? 'md:col-start-2' : ''}`}
          >
            <span class="text-sm text-[var(--color-text-muted)] mb-2 md:text-right">
              Next →
            </span>
            <span class="font-medium text-[var(--var(--color-text)] group-hover:text-[var(--color-primary)] transition-colors md:text-right">
              {nextPost.data.title}
            </span>
          </a>
        )}
      </div>
    </nav>
  </article>
</BaseLayout>
