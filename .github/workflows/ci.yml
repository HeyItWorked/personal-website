name: CI - Build & Security Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# This workflow runs checks on every push/PR
# Cloudflare Pages handles actual deployment automatically

jobs:
  # ==========================================
  # Security Audit
  # ==========================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run security audit
        run: |
          bun audit 2>&1 | tee audit-output.txt || true
          if grep -E "(critical|high)" audit-output.txt > /dev/null; then
            echo "❌ Critical or high severity vulnerabilities found!"
            exit 1
          else
            echo "✅ No critical/high vulnerabilities found"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: security-audit
          path: audit-output.txt

  # ==========================================
  # Build Check
  # Ensures the site builds successfully before Cloudflare tries
  # ==========================================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build site
        run: bun run build

      - name: Check build output
        run: |
          if [ ! -d "dist" ]; then
            echo "❌ Build failed - no dist folder"
            exit 1
          fi
          echo "✅ Build successful"
          echo "Files in dist:"
          ls -la dist/

      - name: Upload build artifact (for inspection)
        uses: actions/upload-artifact@v6
        with:
          name: dist-preview
          path: dist/
          retention-days: 1

  # ==========================================
  # Lighthouse CI (Performance Check)
  # Optional but recommended
  # ==========================================
  # lighthouse:
  #   name: Lighthouse CI
  #   runs-on: ubuntu-latest
  #   needs: build
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Run Lighthouse
  #       uses: treosh/lighthouse-ci-action@v11
  #       with:
  #         configPath: './lighthouserc.json'
